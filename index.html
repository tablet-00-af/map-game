<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>コンパス探索ゲーム</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    padding: 20px;
  }

  button {
    font-size: 16px;
    padding: 10px 20px;
    margin: 8px;
  }

  #compass {
    width: 220px;
    height: 220px;
    border: 3px solid black;
    border-radius: 50%;
    margin: 25px auto;
    position: relative;
  }

  /* ===== コンパス針 ===== */
  #arrow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 6px;
    height: 90px;
    transform-origin: center bottom;
    transform: translate(-50%, -100%) rotate(0deg);
    transition: transform 0.05s linear;
  }

  #needle {
    width: 6px;
    height: 90px;
    background: black;
    position: relative;
  }

  #needle::after {
    content: "";
    position: absolute;
    top: -14px;
    left: -9px;
    width: 24px;
    height: 24px;
    background: red;
    clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
  }

  #distance {
    color: gray;
  }

  #result {
    font-size: 20px;
    margin-top: 15px;
    font-weight: bold;
  }
</style>
</head>
<body>

<h2>コンパス探索ゲーム</h2>

<button onclick="startGame()">スタート</button>
<button onclick="arrive()">ここだ！</button>

<p id="status">未開始</p>

<div id="compass">
  <div id="arrow">
    <div id="needle"></div>
  </div>
</div>

<p id="distance">距離: - m</p>
<p id="result"></p>

<script>
let targetPos = null;
let currentPos = null;
let deviceHeading = 0;
let watchId = null;

let smoothDiff = 0;
let gameState = "ready";

/* 更新制限用 */
let lastGPSUpdate = 0;
let lastCompassUpdate = 0;

/* ===== スタート ===== */
function startGame() {
  if (gameState === "playing") return;

  gameState = "playing";
  smoothDiff = 0;
  document.getElementById("result").textContent = "";
  document.getElementById("status").textContent = "探索中…";

  requestOrientation();

  navigator.geolocation.getCurrentPosition(
    (pos) => {
      const lat = pos.coords.latitude;
      const lon = pos.coords.longitude;
      targetPos = generateTarget(lat, lon);
      startWatch();
    },
    () => alert("位置情報が取得できないよ"),
    { enableHighAccuracy: true }
  );
}

/* ===== 到着 ===== */
function arrive() {
  if (gameState !== "playing" || !currentPos) return;

  gameState = "end";
  navigator.geolocation.clearWatch(watchId);

  const d = calcDistance(
    currentPos.lat,
    currentPos.lon,
    targetPos.lat,
    targetPos.lon
  );

  const score = Math.max(0, Math.round(1000 - d * 10));

  document.getElementById("status").textContent = "ゲーム終了";
  document.getElementById("result").textContent =
    `距離 ${Math.round(d)} m ／ スコア ${score} 点`;
}

/* ===== コンパス許可 ===== */
function requestOrientation() {
  if (
    typeof DeviceOrientationEvent !== "undefined" &&
    typeof DeviceOrientationEvent.requestPermission === "function"
  ) {
    DeviceOrientationEvent.requestPermission().then(res => {
      if (res === "granted") {
        window.addEventListener("deviceorientation", handleOrientation);
      }
    });
  } else {
    window.addEventListener("deviceorientation", handleOrientation);
  }
}

/* ===== 向き取得（30fps制限） ===== */
function handleOrientation(e) {
  const now = Date.now();
  if (now - lastCompassUpdate < 33) return; // 約30fps
  lastCompassUpdate = now;

  if (e.webkitCompassHeading !== undefined) {
    deviceHeading = e.webkitCompassHeading;
  } else if (e.alpha !== null) {
    deviceHeading = 360 - e.alpha;
  }
}

/* ===== 位置追跡（20fps制限） ===== */
function startWatch() {
  watchId = navigator.geolocation.watchPosition(
    (pos) => {
      if (gameState !== "playing") return;

      const now = Date.now();
      if (now - lastGPSUpdate < 50) return; // 20fps
      lastGPSUpdate = now;

      currentPos = {
        lat: pos.coords.latitude,
        lon: pos.coords.longitude
      };

      const d = calcDistance(
        currentPos.lat,
        currentPos.lon,
        targetPos.lat,
        targetPos.lon
      );

      document.getElementById("distance").textContent =
        "距離: " + Math.round(d) + " m";

      const bearing = calcBearing(
        currentPos.lat,
        currentPos.lon,
        targetPos.lat,
        targetPos.lon
      );

      let diff = bearing - deviceHeading;
      diff = ((diff + 540) % 360) - 180;

      /* ノイズ除去 */
      if (Math.abs(diff) < 2) diff = 0;

      /* 条件付き factor */
      const abs = Math.abs(diff);
      let factor;
      if (abs > 60) factor = 0.9;
      else if (abs > 20) factor = 0.6;
      else factor = 0.35;

      smoothDiff += (diff - smoothDiff) * factor;

      document.getElementById("arrow").style.transform =
        `translate(-50%, -100%) rotate(${smoothDiff}deg)`;
    },
    null,
    { enableHighAccuracy: true }
  );
}

/* ===== マーカー生成 ===== */
function generateTarget(lat, lon) {
  const distance = 300 + Math.random() * 300;
  const angle = Math.random() * 2 * Math.PI;

  const dLat = distance * Math.cos(angle) / 111000;
  const dLon = distance * Math.sin(angle) /
    (111000 * Math.cos(lat * Math.PI / 180));

  return { lat: lat + dLat, lon: lon + dLon };
}

/* ===== 距離 ===== */
function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;

  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(lat1)) *
    Math.cos(toRad(lat2)) *
    Math.sin(dLon / 2) ** 2;

  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

/* ===== 方角 ===== */
function calcBearing(lat1, lon1, lat2, lon2) {
  const toRad = x => x * Math.PI / 180;
  const toDeg = x => x * 180 / Math.PI;

  const dLon = toRad(lon2 - lon1);
  const y = Math.sin(dLon) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);

  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}
</script>

</body>
</html>
