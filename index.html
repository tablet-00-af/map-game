<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>„Ç≥„É≥„Éë„ÇπÊé¢Á¥¢„Ç≤„Éº„É†</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  font-family: sans-serif;
  text-align: center;
  padding: 20px;
}
button, select {
  font-size: 16px;
  padding: 8px 16px;
  margin: 6px;
}

/* ===== ÂêçÂâçÊ¨Ñ ===== */
#nameBox {
  position: fixed;
  top: 10px;
  right: 10px;
  background: #fff;
  border: 1px solid #aaa;
  padding: 6px 10px;
  border-radius: 6px;
  font-size: 14px;
  z-index: 1000;
}
#playerName {
  width: 90px;
}

/* ===== „Ç≥„É≥„Éë„Çπ ===== */
#compass {
  width: 220px;
  height: 220px;
  border: 3px solid black;
  border-radius: 50%;
  margin: 20px auto;
  position: relative;
}
#arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 6px;
  height: 90px;
  transform-origin: center bottom;
  transform: translate(-50%, -100%) rotate(0deg);
}
#needle {
  width: 6px;
  height: 90px;
  background: black;
  position: relative;
}
#needle::after {
  content: "";
  position: absolute;
  top: -14px;
  left: -9px;
  width: 24px;
  height: 24px;
  background: red;
  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
}

#result {
  font-size: 20px;
  font-weight: bold;
  margin-top: 15px;
}
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

<!-- ÂêçÂâçÂÖ•Âäõ -->
<div id="nameBox">
  ÂêçÂâçÔºö
  <input id="playerName" type="text" placeholder="ÂêçÂâç">
</div>

<h2>„Ç≥„É≥„Éë„ÇπÊé¢Á¥¢„Ç≤„Éº„É†</h2>

<select id="mode">
  <option value="free">„Éï„É™„Éº„É¢„Éº„Éâ</option>
  <option value="timeattack">„Çø„Ç§„É†„Ç¢„Çø„ÉÉ„ÇØ</option>
  <option value="timelimit">„Çø„Ç§„É†„É™„Éü„ÉÉ„Éà</option>
</select><br>

<button onclick="startGame()">„Çπ„Çø„Éº„Éà</button>
<button onclick="arrive()">„Åì„Åì„Å†ÔºÅ</button><br>

<button onclick="showRanking('timeattack')">TA„É©„É≥„Ç≠„É≥„Ç∞</button>
<button onclick="showRanking('timelimit')">TL„É©„É≥„Ç≠„É≥„Ç∞</button>

<p id="status">Êú™ÈñãÂßã</p>

<div id="compass">
  <div id="arrow"><div id="needle"></div></div>
</div>

<p id="distance"></p>
<p id="timer"></p>
<p id="total"></p>
<p id="result"></p>

<script>
/* ===== FirebaseË®≠ÂÆöÔºàËá™ÂàÜ„ÅÆ„Å´Â§âÊõ¥Ôºâ ===== */
const firebaseConfig = {
  apiKey: "AIzaSyB7igFY8EGnUIgsGq9uUwvttGKcUB18d6Y",
  authDomain: "map-game-47f33.firebaseapp.com",
  projectId: "map-game-47f33"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ===== Â§âÊï∞ ===== */
let targetPos, currentPos;
let deviceHeading = 0;
let watchId = null;
let timerId = null;

let gameMode = "free";
let gameState = "ready";
let startTime = 0;
let totalScore = 0;

const TIME_LIMIT = 600;

/* ===== ÂêçÂâçÂèñÂæó ===== */
function getPlayerName() {
  const n = document.getElementById("playerName").value.trim();
  return n ? n : "NO NAME";
}

/* ===== „Çπ„Çø„Éº„Éà ===== */
function startGame() {
  if (gameState === "playing") return;

  gameMode = document.getElementById("mode").value;
  gameState = "playing";
  startTime = Date.now();
  totalScore = 0;

  document.getElementById("result").textContent = "";
  document.getElementById("total").textContent = "";
  document.getElementById("distance").textContent = "";
  document.getElementById("status").textContent = "Êé¢Á¥¢‰∏≠‚Ä¶";

  requestOrientation();

  navigator.geolocation.getCurrentPosition(pos => {
    targetPos = generateTarget(pos.coords.latitude, pos.coords.longitude);
    startGPS();
    startTimer();
  });
}

/* ===== „Çø„Ç§„Éû„Éº ===== */
function startTimer() {
  clearInterval(timerId);
  timerId = setInterval(() => {
    if (gameState !== "playing") return;

    const elapsed = Math.floor((Date.now() - startTime) / 1000);

    if (gameMode === "timeattack") {
      document.getElementById("timer").textContent =
        `ÁµåÈÅé: ${elapsed}s`;
    }

    if (gameMode === "timelimit") {
      const remain = TIME_LIMIT - elapsed;
      document.getElementById("timer").textContent =
        `ÊÆã„Çä: ${Math.max(0, remain)}s`;

      if (remain <= 0) {
        endGame(`ÊôÇÈñìÂàá„ÇåÔºÅ ÂêàË®à ${totalScore}ÁÇπ`);
        submitScore("timelimit", totalScore);
      }
    }
  }, 500);
}

/* ===== Âà∞ÁùÄ ===== */
function arrive() {
  if (gameState !== "playing" || !currentPos) return;

  const d = calcDistance(
    currentPos.lat, currentPos.lon,
    targetPos.lat, targetPos.lon
  );
  const score = Math.max(0, 100 - Math.floor(d / 10) * 10);

  if (gameMode === "free") {
    endGame(`Ë∑ùÈõ¢ ${Math.round(d)}m / ${score}ÁÇπ`);
  }

  if (gameMode === "timeattack") {
    if (score === 100) {
      const t = ((Date.now() - startTime) / 1000).toFixed(1);
      endGame(`ÊàêÂäüÔºÅ ${t}Áßí`);
      submitScore("timeattack", Number(t));
    } else {
      endGame(`Â§±Êïó‚Ä¶ ${score}ÁÇπ`);
    }
  }

  if (gameMode === "timelimit") {
    totalScore += score;
    document.getElementById("total").textContent =
      `ÂêàË®à: ${totalScore}ÁÇπ`;
    targetPos = generateTarget(currentPos.lat, currentPos.lon);
  }
}

/* ===== ÁµÇ‰∫Ü ===== */
function endGame(msg) {
  gameState = "end";
  navigator.geolocation.clearWatch(watchId);
  clearInterval(timerId);
  document.getElementById("status").textContent = "„Ç≤„Éº„É†ÁµÇ‰∫Ü";
  document.getElementById("result").textContent = msg;
}

/* ===== GPS ===== */
function startGPS() {
  watchId = navigator.geolocation.watchPosition(pos => {
    if (gameState !== "playing") return;

    currentPos = {
      lat: pos.coords.latitude,
      lon: pos.coords.longitude
    };

    const d = calcDistance(
      currentPos.lat, currentPos.lon,
      targetPos.lat, targetPos.lon
    );

    if (gameMode === "free") {
      document.getElementById("distance").textContent =
        `Ë∑ùÈõ¢: ${Math.round(d)}m`;
    }

    const bearing = calcBearing(
      currentPos.lat, currentPos.lon,
      targetPos.lat, targetPos.lon
    );

    document.getElementById("arrow").style.transform =
      `translate(-50%, -100%) rotate(${bearing - deviceHeading}deg)`;
  });
}

/* ===== „Ç≥„É≥„Éë„Çπ ===== */
function requestOrientation() {
  if (DeviceOrientationEvent?.requestPermission) {
    DeviceOrientationEvent.requestPermission().then(r => {
      if (r === "granted")
        window.addEventListener("deviceorientation", e => {
          deviceHeading = e.webkitCompassHeading ?? (360 - e.alpha);
        });
    });
  } else {
    window.addEventListener("deviceorientation", e => {
      deviceHeading = 360 - e.alpha;
    });
  }
}

/* ===== „É©„É≥„Ç≠„É≥„Ç∞ÈÄÅ‰ø° ===== */
function submitScore(mode, value) {
  db.collection("ranking").add({
    name: getPlayerName(),
    mode,
    value,
    time: Date.now()
  });
}

/* ===== „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫ ===== */
async function showRanking(mode) {
  const q = db.collection("ranking")
    .where("mode", "==", mode)
    .orderBy("value", mode === "timeattack" ? "asc" : "desc")
    .limit(5);

  const snap = await q.get();
  let text = "üèÜ „É©„É≥„Ç≠„É≥„Ç∞\n";

  snap.forEach((doc, i) => {
    const d = doc.data();
    text += `${i+1}‰Ωç ${d.name} : ${d.value}\n`;
  });
  alert(text);
}

/* ===== Êï∞Â≠¶ ===== */
function generateTarget(lat, lon) {
  const d = 300 + Math.random() * 300;
  const a = Math.random() * Math.PI * 2;
  return {
    lat: lat + (d * Math.cos(a)) / 111000,
    lon: lon + (d * Math.sin(a)) /
      (111000 * Math.cos(lat * Math.PI / 180))
  };
}
function calcDistance(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const toRad = x => x * Math.PI / 180;
  const dLat = toRad(lat2 - lat1);
  const dLon = toRad(lon2 - lon1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function calcBearing(lat1, lon1, lat2, lon2) {
  const toRad = x => x * Math.PI / 180;
  const toDeg = x => x * 180 / Math.PI;
  const dLon = toRad(lon2 - lon1);
  const y = Math.sin(dLon) * Math.cos(toRad(lat2));
  const x =
    Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
    Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLon);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}
</script>

</body>
</html>
