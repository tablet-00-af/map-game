<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>Compass Quest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
</head>


<style>
/* ===== 全体 ===== */
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
}

/* ===== 名前 ===== */
#nameBox {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(15,23,42,0.9);
  border: 1px solid #38bdf8;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 1000;
}
#playerName {
  width: 90px;
  background: #020617;
  color: #e5e7eb;
  border: 1px solid #38bdf8;
  border-radius: 6px;
  padding: 4px 6px;
}

/* ===== 画面 ===== */
.screen {
  display: none;
  padding-top: 90px;
  min-height: 100vh;
}
.active { display: block; }

/* ===== タイトル ===== */
h1 {
  font-size: 32px;
  letter-spacing: 3px;
  margin-bottom: 30px;
  text-shadow: 0 0 12px rgba(56,189,248,0.8);
}

/* ===== ボタン共通 ===== */
button {
  appearance: none;
  border: none;
  border-radius: 14px;
  padding: 14px 24px;
  margin: 10px;
  font-size: 18px;
  font-weight: bold;
  letter-spacing: 1px;
  color: white;
  cursor: pointer;

  background: linear-gradient(135deg, #3b82f6, #06b6d4);
  box-shadow:
    0 6px 0 #1e40af,
    0 8px 16px rgba(0,0,0,0.4);

  transition: transform 0.05s, box-shadow 0.05s;
}

button:active {
  transform: translateY(4px);
  box-shadow:
    0 2px 0 #1e40af,
    0 4px 8px rgba(0,0,0,0.4);
}

/* メイン */
button.primary {
  font-size: 22px;
  padding: 18px 34px;
  background: linear-gradient(135deg, #ef4444, #f97316);
  box-shadow:
    0 6px 0 #7f1d1d,
    0 8px 16px rgba(0,0,0,0.5);
}

/* 危険 */
button.danger {
  background: linear-gradient(135deg, #6b7280, #111827);
  box-shadow:
    0 6px 0 #020617,
    0 8px 16px rgba(0,0,0,0.5);
}

/* ===== コンパス ===== */
#compass {
  width: 220px;
  height: 220px;
  margin: 20px auto;
  border-radius: 50%;
  background: radial-gradient(circle, #020617, #000);
  border: 3px solid #38bdf8;
  box-shadow: 0 0 20px rgba(56,189,248,0.6);
  position: relative;
}

#arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  transform-origin: center center;
  transform: translate(-50%, -50%) rotate(0deg);
}


#needle {
  position: relative;
  width: 4px;
  height: 90px;
  background: #e5e7eb;
  border-radius: 2px;

  /* 中心から上に伸ばす */
  transform: translateY(-90px);
}

/* 中心の丸 */
#needle::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 16px;
  height: 16px;
  background: #38bdf8;
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(56,189,248,0.6);
}

/* ===== 表示 ===== */
#distance, #timer, #total {
  font-size: 18px;
  margin: 6px;
}

#result {
  font-size: 22px;
  font-weight: bold;
  margin-top: 14px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>

<body>

<div id="nameBox">
  名前：<input id="playerName" placeholder="NO NAME">
</div>

<!-- メニュー -->
<div id="menu" class="screen active">
  <h1>COMPASS QUEST</h1>
  <button onclick="selectMode('free')">フリーモード</button><br>
  <button onclick="selectMode('timeattack')">タイムアタック</button><br>
  <button onclick="selectMode('timelimit')">タイムリミット</button><br><br>
  <button onclick="showRanking('timeattack')">TAランキング</button><br>
  <button onclick="showRanking('timelimit')">TLランキング</button>
</div>

<!-- ゲーム -->
<div id="game" class="screen">
  <p id="status">---</p>

  <div id="compass">
    <div id="arrow"><div id="needle"></div></div>
  </div>

  <p id="distance"></p>
  <p id="timer"></p>
  <p id="total"></p>

  <button id="arriveBtn" class="primary" onclick="confirmArrive()">到着！</button><br>
  <button class="danger" onclick="confirmQuit()">やめる</button>

  <p id="result"></p>
</div>

<script>
/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey: "AIzaSyB7igFY8EGnUIgsGq9uUwvttGKcUB18d6Y",
  authDomain: "map-game-47f33.firebaseapp.com",
  projectId: "map-game-47f33"
});
const db = firebase.firestore();

/* ===== 変数 ===== */
let gameMode=null,targetPos=null,currentPos=null;
let watchId=null,timerId=null;
let deviceHeading=0,startTime=0,totalScore=0;
const TIME_LIMIT=600;

/* ===== 画面 ===== */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ===== モード ===== */
function selectMode(m){
  gameMode=m;
  showScreen("game");
  startGame();
}

/* ===== 確認 ===== */
function confirmArrive(){ if(confirm("ここで到着判定しますか？")) arrive(); }
function confirmQuit(){ if(confirm("ゲームをやめますか？")) quitGame(); }

/* ===== やめる ===== */
function quitGame(){
  stopAll();
  document.getElementById("result").textContent="";
  showScreen("menu");
}

/* ===== 停止 ===== */
function stopAll(){
  const btn = document.getElementById("arriveBtn");
  btn.disabled = true;
  btn.style.opacity = 0.5;

  const el = document.getElementById("status");
  el.textContent = "探索終了";

  if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
  if(timerId){clearInterval(timerId);timerId=null;}
  targetPos=currentPos=gameMode=null;
  startTime=totalScore=0;
  ["distance","timer","total"].forEach(id=>document.getElementById(id).textContent="");
}

/* ===== 開始 ===== */
function startGame(){
  startTime=Date.now();
  totalScore=0;
  requestOrientation();
  navigator.geolocation.getCurrentPosition(p=>{
    targetPos=generateTarget(p.coords.latitude,p.coords.longitude);
    startGPS(); startTimer();
  });

  const btn = document.getElementById("arriveBtn");
  btn.disabled = false;
  btn.style.opacity = 1;

  const el = document.getElementById("status");
　if(gameMode==="timeattack"){
    el.textContent = "タイムアタック / 探索中";
  } else if(gameMode==="timelimit"){
    el.textContent = "タイムリミット / 探索中";
  } else {
    el.textContent = "フリーモード / 探索中";
  }
}

/* ===== タイマー ===== */
function startTimer(){
  timerId=setInterval(()=>{
    const t=Math.floor((Date.now()-startTime)/1000);
    if(gameMode==="timeattack") timer.textContent=`経過 ${t}s`;
    if(gameMode==="timelimit"){
      const r=TIME_LIMIT-t;
      timer.textContent=`残り ${Math.max(0,r)}s`;
      if(r<=0){
        submit("timelimit",totalScore);
        stopAll();
        result.textContent=`終了！ ${totalScore}点`;
      }
    }
  },500);
}

/* ===== 到着 ===== */
function arrive(){
  if(!currentPos||!targetPos) return;
  const d=calcDistance(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
  const score=Math.max(0,100-Math.floor(d/10)*10);

  if(gameMode==="free"){
    stopAll();
    result.textContent=`${Math.round(d)}m / ${score}点`;
  }
  if(gameMode==="timeattack"){
    if(score===100){
      const t=((Date.now()-startTime)/1000).toFixed(1);
      submit("timeattack",Number(t));
      stopAll();
      result.textContent=`成功！ ${t}秒`;
    } else {
      stopAll(); result.textContent=`失敗… / ${Math.round(d)}m`;
    }
  }
  if(gameMode==="timelimit"){
    totalScore+=score;
    total.textContent=`${Math.round(d)}m,${score}点 / 合計 ${totalScore}点`;
    targetPos=generateTarget(currentPos.lat,currentPos.lon);
  }
}

/* ===== GPS & コンパス ===== */
function startGPS(){
  watchId=navigator.geolocation.watchPosition(p=>{
    currentPos={lat:p.coords.latitude,lon:p.coords.longitude};
    const d=calcDistance(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
    const b=calcBearing(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
    arrow.style.transform=`translate(-50%, -100%) rotate(${b-deviceHeading}deg)`;
  });
}

function requestOrientation(){
  if(DeviceOrientationEvent?.requestPermission){
    DeviceOrientationEvent.requestPermission().then(r=>{
      if(r==="granted"){
        window.addEventListener("deviceorientation",e=>{
          deviceHeading=e.webkitCompassHeading??(360-e.alpha);
        });
      }
    });
  } else {
    window.addEventListener("deviceorientation",e=>{
      deviceHeading=360-e.alpha;
    });
  }
}

/* ===== ランキング ===== */
function submit(mode,value){
  db.collection("ranking").add({
    name: playerName.value || "NO NAME",
    mode,value,time:Date.now()
  });
}
async function showRanking(mode){
    alert("ランキングのデータベースに不具合が発生しているため、現在ランキングを表示できません");
}

/* ===== 数学 ===== */
function generateTarget(lat,lon){
  const d=300+Math.random()*300,a=Math.random()*Math.PI*2;
  return {
    lat:lat+d*Math.cos(a)/111000,
    lon:lon+d*Math.sin(a)/(111000*Math.cos(lat*Math.PI/180))
  };
}
function calcDistance(a,b,c,d){
  const R=6371000,to=x=>x*Math.PI/180;
  const A=to(c-a),B=to(d-b);
  const x=Math.sin(A/2)**2+Math.cos(to(a))*Math.cos(to(c))*Math.sin(B/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function calcBearing(a,b,c,d){
  const to=x=>x*Math.PI/180;
  return (Math.atan2(
    Math.sin(to(d-b))*Math.cos(to(c)),
    Math.cos(to(a))*Math.sin(to(c))-
    Math.sin(to(a))*Math.cos(to(c))*Math.cos(to(d-b))
  )*180/Math.PI+360)%360;
}
</script>

</body>
</html>
