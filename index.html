<!DOCTYPE html>
<head>
  <meta charset="UTF-8">
  <title>Compass Quest</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" href="favicon.png">
  <link rel="apple-touch-icon" href="favicon.png">
</head>


<style>
/* ===== 全体 ===== */
body {
  margin: 0;
  font-family: "Segoe UI", sans-serif;
  text-align: center;
  background: radial-gradient(circle at top, #0f172a, #020617);
  color: #e5e7eb;
}

/* ===== 名前 ===== */
#nameBox {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(15,23,42,0.9);
  border: 1px solid #38bdf8;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 14px;
  z-index: 1000;
}
#playerName {
  width: 90px;
  background: #020617;
  color: #e5e7eb;
  border: 1px solid #38bdf8;
  border-radius: 6px;
  padding: 4px 6px;
}

/* ===== 画面 ===== */
.screen {
  display: none;
  padding-top: 90px;
  min-height: 100vh;
}
.active { display: block; }

/* ===== タイトル ===== */
h1 {
  font-size: 32px;
  letter-spacing: 3px;
  margin-bottom: 30px;
  text-shadow: 0 0 12px rgba(56,189,248,0.8);
}

/* ===== ボタン共通 ===== */
button {
  appearance: none;
  border: none;
  border-radius: 14px;
  padding: 14px 24px;
  margin: 10px;
  font-size: 18px;
  font-weight: bold;
  letter-spacing: 1px;
  color: white;
  cursor: pointer;

  background: linear-gradient(135deg, #3b82f6, #06b6d4);
  box-shadow:
    0 6px 0 #1e40af,
    0 8px 16px rgba(0,0,0,0.4);

  transition: transform 0.05s, box-shadow 0.05s;
}

button:active {
  transform: translateY(4px);
  box-shadow:
    0 2px 0 #1e40af,
    0 4px 8px rgba(0,0,0,0.4);
}

/* メイン */
button.primary {
  font-size: 22px;
  padding: 18px 34px;
  background: linear-gradient(135deg, #ef4444, #f97316);
  box-shadow:
    0 6px 0 #7f1d1d,
    0 8px 16px rgba(0,0,0,0.5);
}

/* 危険 */
button.danger {
  background: linear-gradient(135deg, #6b7280, #111827);
  box-shadow:
    0 6px 0 #020617,
    0 8px 16px rgba(0,0,0,0.5);
}

/* ランキング */
.rank1{
  font-size: 1.5em;
  font-weight: bold;
  text-shadow: 0 0 12px rgba(255,215,0,0.8);
}
.rank2or3{
  font-size: 1.2em;
  font-weight: bold;
}

/* ===== コンパス ===== */
#compass {
  width: 220px;
  height: 220px;
  margin: 20px auto;
  border-radius: 50%;
  background: radial-gradient(circle, #020617, #000);
  border: 3px solid #38bdf8;
  box-shadow: 0 0 20px rgba(56,189,248,0.6);
  position: relative;
}

#arrow {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  transform-origin: center center;
  transform: translate(-50%, -50%) rotate(0deg);
}


#needle {
  position: relative;
  width: 4px;
  height: 90px;
  background: #e5e7eb;
  border-radius: 2px;

  /* 中心から上に伸ばす */
  transform: translateY(-90px);
}

/* 中心の丸 */
#needle::after {
  content: "";
  position: absolute;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  width: 16px;
  height: 16px;
  background: #38bdf8;
  border-radius: 50%;
  box-shadow: 0 0 10px rgba(56,189,248,1);
}

/* ===== 表示 ===== */
#distance, #timer, #total {
  font-size: 18px;
  margin: 6px;
}

#result {
  font-size: 22px;
  font-weight: bold;
  margin-top: 14px;
}
</style>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<body>

<div id="nameBox">
  名前：<input id="playerName" placeholder="NO NAME">
</div>

<!-- メニュー -->
<div id="menu" class="screen active">
  <h1>COMPASS QUEST</h1>
  <button onclick="selectMode('free')">フリーモード</button><br>
  <button onclick="selectMode('timeattack')">タイムアタック</button><br>
  <button onclick="selectMode('timelimit')">タイムリミット</button><br><br><br>
  <button onclick="showRanking('timeattack')">ランキング<br>タイムアタック</button><br>
  <button onclick="showRanking('timelimit')">ランキング<br>タイムリミット</button><br><br>
</div>

<!-- ゲーム -->
<div id="game" class="screen">
  <p id="status">---</p>
  <p id="error"></p>

  <div id="compass">
    <div id="arrow"><div id="needle"></div></div>
  </div>

  <p id="distance"></p>
  <p id="timer"></p>
  <p id="total"></p>

  <button id="arriveBtn" class="primary" onclick="confirmArrive()">到着！</button><br>
  <button class="danger" onclick="confirmQuit()">やめる</button>

  <p id="result"></p>

  <audio id="bgm" src="bgm.mp3" loop></audio>
  <audio id="fail" src="fail.mp3"></audio>
  <audio id="success" src="success.mp3"></audio>
  <audio id="happy" src="happy.mp3"></audio>
</div>

<!-- ランキング -->
<div id="rankingScreen" class="screen">
  <p>ランキング</p>
  <h2 id="rankingTitle"></h2>
  <br><br>
  <div id="rankingList"></div>
  <br><br><br>
  <button class="danger" onclick="backToMenu()">もどる</button>
</div>

<script>
/* ===== Firebase ===== */
firebase.initializeApp({
  apiKey: "AIzaSyBkKwHJ6AU3dq8TzT4L8Dpvywozx-qIOWY",
  authDomain: "map-game-47f33.firebaseapp.com",
  projectId: "map-game-47f33"
});
const db = firebase.firestore();

/* ===== 変数 ===== */
let gameMode=null,targetPos=null,currentPos=null;
let watchId=null,timerId=null;
let deviceHeading=0,startTime=0,totalScore=0;
let currentAngle = 0;
const TIME_LIMIT=600;

/* ===== 名前関係 ===== */
const nameInput = document.getElementById("playerName");

nameInput.addEventListener("input", () => {
  localStorage.setItem("playerName", nameInput.value);
});

window.addEventListener("load", () => {
  const savedName = localStorage.getItem("playerName");
  if (savedName) {
    document.getElementById("playerName").value = savedName;
  }
});

/* ===== 画面 ===== */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* ===== BGM/効果音 ======*/
function playBGM(){
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.4; // 音量（0〜1）
  bgm.play();
}

function playSE(id){
  const se = document.getElementById(id);
  se.volume = 0.6;
  se.play();
}

function stopBGM(){
  const bgm = document.getElementById("bgm");
  bgm.pause();
  bgm.currentTime = 0;
}

/* ===== モード ===== */
function selectMode(m){
  gameMode=m;
  showScreen("game");
  startGame();
}

/* ===== 確認 ===== */
function confirmArrive(){ if(confirm("ここで到着判定しますか？")) arrive(); }
function confirmQuit(){ if(confirm("ゲームをやめますか？")) quitGame(); }

/* ===== やめる ===== */
function quitGame(){
  stopAll();
  document.getElementById("result").textContent="";
  showScreen("menu");
}

/* ===== 停止 ===== */
function stopAll(){
  const btn = document.getElementById("arriveBtn");
  btn.disabled = true;
  btn.style.opacity = 0.5;

  const el = document.getElementById("status");
  el.textContent = "探索終了";

  if(watchId){navigator.geolocation.clearWatch(watchId);watchId=null;}
  if(timerId){clearInterval(timerId);timerId=null;}
  targetPos=currentPos=gameMode=null;
  startTime=totalScore=0;
  ["distance","timer","total"].forEach(id=>document.getElementById(id).textContent="");

  stopBGM();
}

/* ===== 開始 ===== */
function startGame(){
  startTime=Date.now();
  totalScore=0;
  requestOrientation();
  navigator.geolocation.getCurrentPosition(p=>{
    targetPos=generateTarget(p.coords.latitude,p.coords.longitude);
    startGPS(); startTimer();
  });

  const btn = document.getElementById("arriveBtn");
  btn.disabled = false;
  btn.style.opacity = 1;

  const el = document.getElementById("status");
　if(gameMode==="timeattack"){
    el.textContent = "タイムアタック / 探索中";
  } else if(gameMode==="timelimit"){
    el.textContent = "タイムリミット / 探索中";
  } else {
    el.textContent = "フリーモード / 探索中";
  }

  playBGM();
}

/* ===== タイマー ===== */
function startTimer(){
  timerId=setInterval(()=>{
    const t=Math.floor((Date.now()-startTime)/1000);
    if(gameMode==="timeattack") timer.textContent=`経過 ${t}s`;
    if(gameMode==="timelimit"){
      const r=TIME_LIMIT-t;
      timer.textContent=`残り ${Math.max(0,r)}s`;
      if(r<=0){
        submit("timelimit",totalScore);
        stopAll();
        result.textContent=`終了！ ${totalScore}点`;
      }
    }
  },500);
}

/* ===== 到着 ===== */
function arrive(){
  if(!currentPos||!targetPos) return;
  const d=calcDistance(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
  const score=Math.max(0,100-Math.floor(d/10)*10);

  if(gameMode==="free"){
    stopAll();
    result.textContent=`${Math.round(d)}m先 / ${score}点`;
  }
  if(gameMode==="timeattack"){
    if(score===100){
      const t=((Date.now()-startTime)/1000).toFixed(1);
      submit("timeattack",Number(t));
      stopAll();
      result.textContent=`成功！ ${t}秒 / ${Math.round(d)}m先`;
    } else {
      stopAll();
      result.textContent=`失敗… / ${Math.round(d)}m先`;
    }
  }
  if(gameMode==="timelimit"){
    totalScore+=score;
    total.textContent=`${Math.round(d)}m先,${score}点 / 合計 ${totalScore}点`;
    targetPos=generateTarget(currentPos.lat,currentPos.lon);
  }

  if(score===100){
    playSE("happy");
  }else if(score > 0){
    playSE("success");
  }else{
    playSE("fail");
  }
}

/* ===== GPS & コンパス ===== */
function startGPS(){
  watchId=navigator.geolocation.watchPosition(p=>{
    error.textContent="";
    currentPos={lat:p.coords.latitude,lon:p.coords.longitude};
    const d=calcDistance(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
    const b=calcBearing(currentPos.lat,currentPos.lon,targetPos.lat,targetPos.lon);
    currentAngle = b - deviceHeading;
    arrow.style.transform=`translate(-50%, -100%) rotate(${currentAngle}deg)`;
  },
  err => {
    error.textContent="位置情報が取得できません";
    currentAngle = currentAngle + (Math.random() * 360);
    arrow.style.transform=`translate(-50%, -50%) rotate(${currentAngle}deg)`;
  });
}

function requestOrientation(){
  if(DeviceOrientationEvent?.requestPermission){
    DeviceOrientationEvent.requestPermission().then(r=>{
      if(r==="granted"){
        window.addEventListener("deviceorientation",e=>{
          deviceHeading=e.webkitCompassHeading??(360-e.alpha);
        });
      }
    });
  } else {
    window.addEventListener("deviceorientation",e=>{
      deviceHeading=360-e.alpha;
    });
  }
}

/* ===== ランキング ===== */
function submit(mode, value){
  const name =
    localStorage.getItem("playerName") || "NO NAME";

  db.collection("ranking").add({
    name: name,
    mode: mode,
    value: Number(value),
    time: Date.now()
  });
}

async function showRanking(mode){
  showScreen("rankingScreen");

  const title = document.getElementById("rankingTitle");
  const list = document.getElementById("rankingList");

  title.textContent =
    mode === "timeattack" ? "タイムアタック" : "タイムリミット";

  list.innerHTML = "読み込み中…";

  try {
    const order = mode === "timeattack" ? "asc" : "desc";

    const snapshot = await db.collection("ranking")
      .where("mode", "==", mode)
      .orderBy("value", order)
      .limit(5)
      .get();

    // 0件のとき
    if (snapshot.empty) {
      list.innerHTML = "まだ記録がありません";
      return;
    }

    // 表示作成
    list.innerHTML = "";

    let rank = 0;
    let beforeValue = null;
    let index = 0;

    snapshot.forEach(doc => {
      const d = doc.data();
      const value = Number(d.value);
      const row = document.createElement("div");

      if (beforeValue === null || value !== beforeValue) {
        rank = index + 1;
      }
      beforeValue = value;

      row.textContent =
        mode === "timeattack"
          ? `${rank}位 ${d.name} : ${value}s`
          : `${rank}位 ${d.name} : ${value}点`;

      if (rank === 1) {
        row.classList.add("rank1");
      } else if (rank === 2 || rank === 3) {
        row.classList.add("rank2or3");
      }

      list.appendChild(row);
      index++;
    });

  } catch (e) {
    console.error(e);
    list.innerHTML = "ランキングの取得に失敗しました";
  }
}

function backToMenu(){
  showScreen("menu");
}

/* ===== 計算 ===== */
function generateTarget(lat,lon){
  const d=300+Math.random()*300,a=Math.random()*Math.PI*2;
  return {
    lat:lat+d*Math.cos(a)/111000,
    lon:lon+d*Math.sin(a)/(111000*Math.cos(lat*Math.PI/180))
  };
}
function calcDistance(a,b,c,d){
  const R=6371000,to=x=>x*Math.PI/180;
  const A=to(c-a),B=to(d-b);
  const x=Math.sin(A/2)**2+Math.cos(to(a))*Math.cos(to(c))*Math.sin(B/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function calcBearing(a,b,c,d){
  const to=x=>x*Math.PI/180;
  return (Math.atan2(
    Math.sin(to(d-b))*Math.cos(to(c)),
    Math.cos(to(a))*Math.sin(to(c))-
    Math.sin(to(a))*Math.cos(to(c))*Math.cos(to(d-b))
  )*180/Math.PI+360)%360;
}
</script>
</body>
</html>
